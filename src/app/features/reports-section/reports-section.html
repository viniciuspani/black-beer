<div class="reports-container">

  <!-- ==================== CARD PRINCIPAL ==================== -->
  <p-card styleClass="reports-card">

    <!-- ==================== HEADER ==================== -->
    <ng-template pTemplate="title">
      <div class="card-header">
        <div class="header-content">
          <i class="pi pi-chart-bar"></i>
          <div class="header-text">
            <span class="header-title">Relatórios de Vendas</span>
            <span class="header-subtitle">Análise de desempenho</span>
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="content">

      <!-- ==================== FILTROS DE PERÍODO ==================== -->
      <div class="filters-section">

        <!-- Filtros Rápidos -->
        <div class="filters-quick-card">
          <h4 class="filters-subtitle">
            <i class="pi pi-filter"></i>
            Filtros Rápidos
          </h4>

          <div class="filters-grid">
            <button
              type="button"
              class="filter-button"
              [class.filter-button-active]="selectedPeriod() === 'today'"
              (click)="setPeriod('today')">
              <i class="pi pi-calendar"></i>
              <span>Hoje</span>
            </button>

            <button
              type="button"
              class="filter-button"
              [class.filter-button-active]="selectedPeriod() === 'week'"
              (click)="setPeriod('week')">
              <i class="pi pi-calendar-plus"></i>
              <span>Semana</span>
            </button>

            <button
              type="button"
              class="filter-button"
              [class.filter-button-active]="selectedPeriod() === 'month'"
              (click)="setPeriod('month')">
              <i class="pi pi-calendar-times"></i>
              <span>Mês</span>
            </button>

            <button
              type="button"
              class="filter-button"
              [class.filter-button-active]="selectedPeriod() === 'all'"
              (click)="setPeriod('all')">
              <i class="pi pi-infinity"></i>
              <span>Tudo</span>
            </button>
          </div>
        </div>

        <!-- Filtro por Range de Data -->
        <div class="filters-custom-card">
          <h4 class="filters-subtitle">
            <i class="pi pi-calendar-minus"></i>
            Período Personalizado
          </h4>

          <div class="filters-custom-grid">
            <!-- Data Inicial -->
            <div class="filter-date-field">
              <label for="startDate" class="filter-date-label">
                <i class="pi pi-calendar-plus"></i>
                Data Inicial
              </label>
              <p-datepicker
                [(ngModel)]="startDate"
                inputId="startDate"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                [iconDisplay]="'input'"
                placeholder="Ex: 01/01/2025"
                [showButtonBar]="false"
                [readonlyInput]="false"
                styleClass="custom-calendar">
              </p-datepicker>
            </div>

            <!-- Data Final -->
            <div class="filter-date-field">
              <label for="endDate" class="filter-date-label">
                <i class="pi pi-calendar-minus"></i>
                Data Final
              </label>
              <p-datepicker
                [(ngModel)]="endDate"
                inputId="endDate"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                [iconDisplay]="'input'"
                placeholder="Ex: 31/01/2025"
                [showButtonBar]="false"
                [readonlyInput]="false"
                styleClass="custom-calendar">
              </p-datepicker>
            </div>

            <!-- Botões de Ação -->
            <div class="filter-date-actions">
              <p-button
                type="button"
                label="Filtrar"
                icon="pi pi-search"
                severity="success"
                [disabled]="!startDate() || !endDate()"
                (onClick)="applyCustomFilter()">
              </p-button>

              <p-button
                type="button"
                label="Limpar"
                icon="pi pi-times"
                severity="secondary"
                [outlined]="true"
                [disabled]="!hasCustomFilter()"
                (onClick)="clearCustomFilter()">
              </p-button>
            </div>
          </div>

          <!-- Indicador de Filtro Ativo -->
          @if (hasCustomFilter()) {
            <div class="filter-active-indicator">
              <i class="pi pi-check-circle"></i>
              <span>Filtro ativo: {{ startDate() | date:'dd/MM/yyyy' }} até {{ endDate() | date:'dd/MM/yyyy' }}</span>
            </div>
          }
        </div>
      </div>

      <!-- ==================== CARDS DE MÉTRICAS ==================== -->
      <div class="metrics-section">
        <div class="metrics-grid">

          <!-- Card: Total de Vendas -->
          <div class="metric-card metric-card-primary">
            <div class="metric-icon">
              <i class="pi pi-shopping-cart"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Total de Vendas</span>
              <span class="metric-value">{{ getTotalSales() }}</span>
              <span class="metric-subtitle">vendas realizadas</span>
            </div>
          </div>

          <!-- Card: Volume Total -->
          <div class="metric-card metric-card-info">
            <div class="metric-icon">
              <i class="pi pi-box"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Volume Total</span>
              <span class="metric-value">{{ getTotalVolume() }}L</span>
              <span class="metric-subtitle">litros vendidos</span>
            </div>
          </div>

          <!-- Card: Cerveja Mais Vendida -->
          <div class="metric-card metric-card-success">
            <div class="metric-icon">
              <i class="pi pi-star"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Mais Vendida</span>
              <span class="metric-value">{{ getTopBeer() }}</span>
              <span class="metric-subtitle">cerveja líder</span>
            </div>
          </div>

          <!-- Card: Tamanho Preferido -->
          <div class="metric-card metric-card-warning">
            <div class="metric-icon">
              <i class="pi pi-shopping-bag"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Tamanho Preferido</span>
              <span class="metric-value">{{ getPreferredSize() }}ml</span>
              <span class="metric-subtitle">mais escolhido</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== GRÁFICOS (Chart.js) ==================== -->
      <div class="charts-section">

        <!-- Gráfico: Pizza - Vendas por Cerveja -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="pi pi-chart-pie"></i>
              Vendas por Cerveja
            </h3>
          </div>
          <div class="chart-content">
            @if (pieChartData().labels?.length) {
              <canvas
                baseChart
                [data]="pieChartData()"
                [type]="'pie'"
                [options]="pieChartOptions">
              </canvas>
            } @else {
              <div class="no-data-chart">
                <i class="pi pi-chart-pie"></i>
                <p>Nenhum dado disponível</p>
              </div>
            }
          </div>
        </div>

        <!-- Gráfico: Barras - Vendas por Tamanho -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="pi pi-chart-bar"></i>
              Vendas por Tamanho
            </h3>
          </div>
          <div class="chart-content">
            @if (barChartData().labels?.length) {
              <canvas
                baseChart
                [data]="barChartData()"
                [type]="'bar'"
                [options]="barChartOptions">
              </canvas>
            } @else {
              <div class="no-data-chart">
                <i class="pi pi-chart-bar"></i>
                <p>Nenhum dado disponível</p>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- ==================== RESUMO DE DADOS AGREGADOS (SUBSTITUI TABELA) ==================== -->
      <div class="aggregated-data-section">
        <div class="data-header">
          <h3 class="data-title">
            <i class="pi pi-list"></i>
            Dados Detalhados
          </h3>
        </div>

        <!-- Desktop: Grid 2 colunas -->
        <div class="hidden md:grid md:grid-cols-2 gap-6">
          <!-- Vendas por Cerveja -->
          <div class="data-card">
            <h4 class="data-card-title">
              <i class="pi pi-moon"></i>
              Vendas por Cerveja
            </h4>
            <div class="data-card-content">
              @for (beer of report().salesByBeerType; track beer.beerId) {
                <div class="data-row">
                  <div class="data-row-left">
                    <div class="beer-color-dot" [style.background-color]="beer.color"></div>
                    <span class="data-row-name">{{ beer.name }}</span>
                  </div>
                  <div class="data-row-right">
                    <span class="data-row-value">{{ beer.totalCups }} copos</span>
                    <span class="data-row-subvalue">{{ beer.totalLiters.toFixed(2) }}L</span>
                  </div>
                </div>
              } @empty {
                <p class="no-data-text">Nenhuma venda registrada</p>
              }
            </div>
          </div>

          <!-- Vendas por Tamanho -->
          <div class="data-card">
            <h4 class="data-card-title">
              <i class="pi pi-shopping-bag"></i>
              Vendas por Tamanho
            </h4>
            <div class="data-card-content">
              @for (size of report().salesByCupSize; track size.cupSize) {
                <div class="data-row">
                  <div class="data-row-left">
                    <i class="pi pi-box size-icon"></i>
                    <span class="data-row-name">{{ size.cupSize }}ml</span>
                  </div>
                  <div class="data-row-right">
                    <span class="data-row-value">{{ size.count }} copos</span>
                  </div>
                </div>
              } @empty {
                <p class="no-data-text">Nenhuma venda registrada</p>
              }
            </div>
          </div>
        </div>

        <!-- Mobile: Cards empilhados -->
        <div class="md:hidden flex flex-col gap-4">
          <!-- Vendas por Cerveja -->
          <div class="data-card">
            <h4 class="data-card-title">
              <i class="pi pi-moon"></i>
              Vendas por Cerveja
            </h4>
            <div class="data-card-content">
              @for (beer of report().salesByBeerType; track beer.beerId) {
                <div class="data-row">
                  <div class="data-row-left">
                    <div class="beer-color-dot" [style.background-color]="beer.color"></div>
                    <span class="data-row-name">{{ beer.name }}</span>
                  </div>
                  <div class="data-row-right">
                    <span class="data-row-value">{{ beer.totalCups }} copos</span>
                    <span class="data-row-subvalue">{{ beer.totalLiters.toFixed(2) }}L</span>
                  </div>
                </div>
              } @empty {
                <p class="no-data-text">Nenhuma venda registrada</p>
              }
            </div>
          </div>

          <!-- Vendas por Tamanho -->
          <div class="data-card">
            <h4 class="data-card-title">
              <i class="pi pi-shopping-bag"></i>
              Vendas por Tamanho
            </h4>
            <div class="data-card-content">
              @for (size of report().salesByCupSize; track size.cupSize) {
                <div class="data-row">
                  <div class="data-row-left">
                    <i class="pi pi-box size-icon"></i>
                    <span class="data-row-name">{{ size.cupSize }}ml</span>
                  </div>
                  <div class="data-row-right">
                    <span class="data-row-value">{{ size.count }} copos</span>
                  </div>
                </div>
              } @empty {
                <p class="no-data-text">Nenhuma venda registrada</p>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== SEÇÃO DE EXPORTAÇÃO ==================== -->
      <div class="export-section">
        <p-card styleClass="export-card">
          <ng-template pTemplate="header">
            <div class="export-header">
              <i class="pi pi-send"></i>
              <h3>Exportar Relatório</h3>
            </div>
          </ng-template>

          <ng-template pTemplate="content">
            <div class="export-content">
              <!-- Download Local -->
              <div class="export-option">
                <div class="option-header">
                  <i class="pi pi-download text-blue-600"></i>
                  <h4>Baixar CSV</h4>
                </div>
                <p class="option-description">Baixe o relatório em formato CSV para seu computador</p>
                <p-button
                  label="Baixar Relatório"
                  icon="pi pi-download"
                  severity="secondary"
                  [outlined]="true"
                  styleClass="w-full"
                  (onClick)="downloadCSV()">
                </p-button>
              </div>

              <div class="divider"></div>

              <!-- Enviar por Email -->
              <div class="export-option">
                <div class="option-header">
                  <i class="pi pi-envelope text-amber-600"></i>
                  <h4>Enviar por Email</h4>
                </div>
                <p class="option-description">Envie o relatório para até 10 destinatários (separados por vírgula)</p>

                <div class="email-form">
                  <div class="form-group">
                    <label for="email-recipients" class="form-label">
                      <i class="pi pi-users"></i>
                      Destinatários
                    </label>
                    <input
                      id="email-recipients"
                      type="text"
                      pInputText
                      [(ngModel)]="emailRecipients"
                      placeholder="exemplo@email.com, outro@email.com"
                      class="w-full"
                      [disabled]="isSendingEmail()">
                    <small class="form-hint">Máximo de 10 emails, separados por vírgula</small>
                  </div>

                  @if (isSendingEmail() && uploadProgress() > 0) {
                    <div class="progress-container">
                      <div class="progress-bar">
                        <div
                          class="progress-fill"
                          [style.width.%]="uploadProgress()">
                        </div>
                      </div>
                      <span class="progress-text">{{ uploadProgress() }}%</span>
                    </div>
                  }

                  <p-button
                    label="Enviar Relatório"
                    icon="pi pi-send"
                    severity="success"
                    styleClass="w-full"
                    [loading]="isSendingEmail()"
                    [disabled]="!emailRecipients() || isSendingEmail()"
                    (onClick)="sendReportByEmail()">
                  </p-button>
                </div>
              </div>

              <!-- Info Card -->
              <div class="export-info">
                <i class="pi pi-info-circle"></i>
                <div class="info-content">
                  <p class="info-title">Formato do Relatório</p>
                  <ul class="info-list">
                    <li>Resumo de vendas (total e volume)</li>
                    <li>Vendas por tipo de cerveja</li>
                    <li>Vendas por tamanho de copo</li>
                    <li>Período do relatório filtrado</li>
                  </ul>
                </div>
              </div>
            </div>
          </ng-template>
        </p-card>
      </div>

    </ng-template>
  </p-card>

  <!-- Toast para mensagens -->
  <p-toast></p-toast>

</div>
