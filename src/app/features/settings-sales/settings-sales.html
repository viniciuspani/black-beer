<!-- src/app/features/settings-sales/settings-sales.html -->
<div class="settings-sales-container">
  <p-toast />

  <!-- Header -->
  <div class="page-header">
    <h2>
      <i class="pi pi-shopping-cart"></i>
      Controle de Estoque e Preços
    </h2>
    <p class="header-description">
      Configure a quantidade de litros disponível e os preços para cada cerveja.
      Selecione um evento para configurações específicas ou deixe em "Geral" para configurações padrão.
    </p>
  </div>

  <!-- Seletor de Evento -->
  <p-card class="event-selector-card">
    <ng-template pTemplate="header">
      <div class="card-header-with-icon">
        <i class="pi pi-calendar"></i>
        <span>Selecionar Evento</span>
      </div>
    </ng-template>

    <div class="event-selector-content">
      <label for="event-select" class="event-selector-label">
        Configure estoque e preços para:
      </label>

      <div class="event-selector-buttons">
        <!-- Botão "Geral" (sem evento específico) -->
        <button
          type="button"
          class="event-button"
          [class.event-button-active]="selectedEventId() === null"
          (click)="onEventChange(null)">
          <i class="pi pi-globe"></i>
          <div class="event-button-content">
            <span class="event-button-title">Geral</span>
            <span class="event-button-subtitle">Configuração padrão</span>
          </div>
        </button>

        <!-- Botões de eventos ativos -->
        @for (event of availableEvents(); track event.num_id) {
          <button
            type="button"
            class="event-button"
            [class.event-button-active]="selectedEventId() === event.num_id"
            (click)="onEventChange(event.num_id)">
            <i class="pi pi-calendar-plus"></i>
            <div class="event-button-content">
              <span class="event-button-title">{{ event.desc_name_event }}</span>
              <span class="event-button-subtitle">{{ event.desc_local_event }}</span>
            </div>
          </button>
        }
      </div>

      @if (availableEvents().length === 0) {
        <div class="no-events-message">
          <i class="pi pi-info-circle"></i>
          <p>Nenhum evento ativo disponível. Crie um evento na seção de Gerenciar Eventos.</p>
        </div>
      }
    </div>
  </p-card>

  <!-- Alertas de Estoque Baixo -->
  @if (stockAlerts().length > 0) {
    <p-card class="alerts-card" styleClass="alert-card">
      <ng-template #header>
        <div class="card-header-with-icon">
          <i class="pi pi-exclamation-triangle"></i>
          <span>Alertas de Estoque Baixo</span>
        </div>
      </ng-template>

      <div class="alerts-list">
        @for (alert of stockAlerts(); track alert.beerId) {
          <div class="alert-item">
            <div class="alert-beer-info">
              <div
                class="beer-color-indicator"
                [style.background-color]="alert.color">
              </div>
              <span class="beer-name">{{ alert.beerName }}</span>
            </div>
            <div class="alert-quantity">
              <i class="pi pi-exclamation-circle"></i>
              <span>{{ alert.quantidadeLitros }}L restantes</span>
            </div>
          </div>
        }
      </div>
    </p-card>
  }

  <!-- Lista de Cervejas com Controle de Estoque -->
  <p-card class="stocks-card">
    <ng-template #header>
      <div class="card-header-with-actions">
        <div class="card-header-with-icon">
          <i class="pi pi-box"></i>
          <span>Estoque de Cervejas</span>
        </div>
        @if (hasModifications()) {
          <p-button
            label="Salvar Todos"
            icon="pi pi-save"
            (onClick)="saveAllStocks()"
            [loading]="isSaving()"
            severity="success"
          />
        }
      </div>
    </ng-template>

    <div class="stocks-grid">
      @for (stock of beerStocks(); track stock.beerId) {
        <div class="stock-item">
          <!-- Header do Item -->
          <div class="stock-header">
            <div class="beer-info">
              <div
                class="beer-color-indicator"
                [style.background-color]="stock.color">
              </div>
              <h3>{{ stock.beerName }}</h3>
            </div>
            <p-tag
              [value]="getStatusText(getBeerStatus(stock))"
              [severity]="getStatusSeverity(getBeerStatus(stock))"
            />
          </div>

          <!-- Display de Quantidade Atual (quando controle ativo) -->
          @if (stock.originalQuantity > 0) {
            <div class="current-stock-display" [ngClass]="getStockDisplayClass(stock)">
              <div class="stock-icon">
                <i class="pi pi-database"></i>
              </div>
              <div class="stock-info">
                <span class="stock-label">Estoque Atual</span>
                <span class="stock-value">{{ stock.originalQuantity.toFixed(1) }}L</span>
              </div>
              @if (getBeerStatus(stock) === 'alert' || getBeerStatus(stock) === 'depleted') {
                <i class="pi pi-exclamation-triangle warning-icon"></i>
              }
            </div>
          }

          <!-- Input de Quantidade -->
          <div class="stock-input-group">
            <label [for]="'stock-' + stock.beerId">
              <i class="pi pi-box"></i>
              Quantidade Disponível
            </label>
            <p-inputnumber
              [id]="'stock-' + stock.beerId"
              [(ngModel)]="stock.quantidadeLitros"
              [min]="0"
              [max]="10000"
              suffix=" litros"
              [showButtons]="true"
              [step]="1"
              mode="decimal"
              [minFractionDigits]="1"
              [maxFractionDigits]="1"
              class="w-full"
              placeholder="0 = sem controle"
              pTooltip="Defina a quantidade inicial. Clique 'Remover Controle' para desativar."
              tooltipPosition="top"
            />

            <!-- Informação sobre o modo -->
            @if (stock.originalQuantity === 0) {
              <small class="info-text">
                <i class="pi pi-info-circle"></i>
                Sem controle de estoque. Vendas não serão subtraídas.
              </small>
            } @else {
              <small class="info-text success">
                <i class="pi pi-check-circle"></i>
                Controle ativo. Vendas serão subtraídas automaticamente.
              </small>
            }
          </div>

          <!-- Input de Limite de Alerta (somente se controle ativo) -->
          @if (stock.originalQuantity > 0 || stock.quantidadeLitros > 0) {
            <div class="stock-input-group">
              <label [for]="'alert-' + stock.beerId">
                <i class="pi pi-bell"></i>
                Limite de Alerta (L)
              </label>
              <p-inputnumber
                [id]="'alert-' + stock.beerId"
                [(ngModel)]="stock.minLitersAlert"
                [min]="0"
                [max]="stock.quantidadeLitros"
                suffix=" litros"
                [showButtons]="true"
                [step]="0.5"
                mode="decimal"
                [minFractionDigits]="1"
                [maxFractionDigits]="1"
                class="w-full"
                placeholder="5.0"
                pTooltip="Alerta será exibido quando o estoque ficar abaixo deste valor"
                tooltipPosition="top"
              />
              <small class="info-text">
                <i class="pi pi-info-circle"></i>
                Você será alertado quando o estoque cair abaixo de {{ stock.minLitersAlert }}L
              </small>
            </div>
          }

          <!-- Ações -->
          <div class="stock-actions">
            @if (isStockModified(stock)) {
              <p-button
                label="Salvar"
                icon="pi pi-check"
                (onClick)="saveStockForBeer(stock)"
                severity="success"
                [outlined]="true"
                size="small"
              />
            }

            @if (stock.originalQuantity > 0) {
              <p-button
                label="Remover Controle"
                icon="pi pi-times"
                (onClick)="resetStockForBeer(stock)"
                severity="danger"
                [outlined]="true"
                size="small"
                pTooltip="Remove o controle de estoque (volta ao modo normal)"
                tooltipPosition="top"
              />
            }
          </div>
        </div>
      }
    </div>

    @if (beerStocks().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <p>Nenhuma cerveja cadastrada</p>
        <small>Cadastre cervejas em Configurações > Cervejas</small>
      </div>
    }
  </p-card>

  <!-- Card de Configuração de Preços -->
  <p-card class="prices-card">
    <ng-template #header>
      <div class="card-header-with-icon">
        <i class="pi pi-dollar"></i>
        <span>Configuração de Preços</span>
      </div>
    </ng-template>

    <div class="prices-description">
      <i class="pi pi-info-circle"></i>
      <p>
        Defina os preços para cada tamanho de copo (300ml, 500ml e 1000ml) de cada cerveja.
      </p>
    </div>

    <div class="beer-prices-grid">
      @for (price of beerPrices(); track price.beerId) {
        <div class="beer-price-card">
          <!-- Header do card -->
          <div class="beer-price-header">
            <div class="beer-info">
              <div class="beer-color-indicator" [style.background-color]="price.color"></div>
              <h4>{{ price.beerName }}</h4>
            </div>
          </div>

          <!-- Grid de inputs de preços -->
          <div class="price-inputs-grid">
            <!-- Preço 300ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                300ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price300ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [max]="999.99"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>

            <!-- Preço 500ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                500ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price500ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [max]="999.99"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>

            <!-- Preço 1000ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                1000ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price1000ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [max]="999.99"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>
          </div>

          <!-- Botão de salvar -->
          <div class="beer-price-actions">
            <p-button
              label="Salvar Preços"
              icon="pi pi-check"
              (onClick)="savePriceForBeer(price)"
              severity="success"
              size="small"
              [disabled]="!hasPriceChanges(price)"
            />
          </div>
        </div>
      }
    </div>

    @if (beerPrices().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <p>Nenhuma cerveja cadastrada</p>
        <small>Cadastre cervejas em Configurações > Cervejas</small>
      </div>
    }

    <!-- Botão de salvar todos -->
    @if (beerPrices().length > 0) {
      <div class="save-all-prices-section">
        <p-button
          label="Salvar Todos os Preços"
          icon="pi pi-save"
          (onClick)="saveAllPrices()"
          severity="primary"
          [loading]="isSaving()"
        />
      </div>
    }
  </p-card>

  <!-- Card de Ajuda -->
  <p-card class="help-card">
    <ng-template #header>
      <div class="card-header-with-icon">
        <i class="pi pi-question-circle"></i>
        <span>Como Funciona</span>
      </div>
    </ng-template>

    <div class="help-content">
      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Modo Normal (0 litros)</strong>
          <p>Sem controle de estoque. O sistema não subtrai vendas.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Controle Ativo (> 0 litros)</strong>
          <p>Sistema subtrai automaticamente as vendas do estoque configurado.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Alertas</strong>
          <p>Notificação quando estoque ficar abaixo do limite configurado.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Exemplo</strong>
          <p>Configure 50L de IPA. Ao vender 5L (10 copos de 500ml), o estoque cai para 45L automaticamente.</p>
        </div>
      </div>
    </div>
  </p-card>
</div>
