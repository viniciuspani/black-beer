<!-- src/app/features/settings-sales/settings-sales.html -->
<div class="settings-sales-container">
  <p-toast />

  <!-- Header -->
  <div class="page-header">
    <h2>
      <i class="pi pi-shopping-cart"></i>
      Controle de Estoque por Evento
    </h2>
    <p class="header-description">
      Configure a quantidade de litros disponível para cada cerveja no evento.
      Quando configurado, o sistema automaticamente subtrai as vendas do estoque.
    </p>
  </div>

  <!-- Alertas de Estoque Baixo -->
  @if (stockAlerts().length > 0) {
    <p-card class="alerts-card" styleClass="alert-card">
      <ng-template #header>
        <div class="card-header-with-icon">
          <i class="pi pi-exclamation-triangle"></i>
          <span>Alertas de Estoque Baixo</span>
        </div>
      </ng-template>

      <div class="alerts-list">
        @for (alert of stockAlerts(); track alert.beerId) {
          <div class="alert-item">
            <div class="alert-beer-info">
              <div
                class="beer-color-indicator"
                [style.background-color]="alert.color">
              </div>
              <span class="beer-name">{{ alert.beerName }}</span>
            </div>
            <div class="alert-quantity">
              <i class="pi pi-exclamation-circle"></i>
              <span>{{ alert.quantidadeLitros }}L restantes</span>
            </div>
          </div>
        }
      </div>
    </p-card>
  }

  <!-- Card de Configuração de Alertas -->
  <p-card class="alert-config-card">
    <ng-template #header>
      <div class="card-header-with-icon">
        <i class="pi pi-bell"></i>
        <span>Configuração de Alertas</span>
      </div>
    </ng-template>

    <div class="alert-config-content">
      <div class="config-description">
        <i class="pi pi-info-circle"></i>
        <p>
          Defina o limite mínimo de litros para receber alertas de estoque baixo.
          O sistema irá notificar quando qualquer cerveja atingir esse limite.
        </p>
      </div>

      <div class="config-input-group">
        <label for="min-liters">
          <i class="pi pi-bell"></i>
          Limite Mínimo de Alerta
        </label>
        <p-inputnumber
          id="min-liters"
          [(ngModel)]="minLitersAlert"
          [min]="0"
          [max]="1000"
          suffix=" litros"
          [showButtons]="true"
          [step]="1"
          mode="decimal"
          [minFractionDigits]="1"
          [maxFractionDigits]="1"
          class="w-full"
        />

        @if (isAlertConfigModified()) {
          <p-button
            label="Salvar Alerta"
            icon="pi pi-save"
            (onClick)="saveAlertConfig()"
            severity="success"
            [outlined]="true"
            styleClass="mt-2"
          />
        }
      </div>
    </div>
  </p-card>

  <!-- Lista de Cervejas com Controle de Estoque -->
  <p-card class="stocks-card">
    <ng-template #header>
      <div class="card-header-with-actions">
        <div class="card-header-with-icon">
          <i class="pi pi-box"></i>
          <span>Estoque de Cervejas</span>
        </div>
        @if (hasModifications()) {
          <p-button
            label="Salvar Todos"
            icon="pi pi-save"
            (onClick)="saveAllStocks()"
            [loading]="isSaving()"
            severity="success"
          />
        }
      </div>
    </ng-template>

    <div class="stocks-grid">
      @for (stock of beerStocks(); track stock.beerId) {
        <div class="stock-item">
          <!-- Header do Item -->
          <div class="stock-header">
            <div class="beer-info">
              <div
                class="beer-color-indicator"
                [style.background-color]="stock.color">
              </div>
              <h3>{{ stock.beerName }}</h3>
            </div>
            <p-tag
              [value]="getStatusText(getBeerStatus(stock))"
              [severity]="getStatusSeverity(getBeerStatus(stock))"
            />
          </div>

          <!-- Display de Quantidade Atual (quando controle ativo) -->
          @if (stock.originalQuantity > 0) {
            <div class="current-stock-display" [class.low-stock]="getBeerStatus(stock) === 'alert'">
              <div class="stock-icon">
                <i class="pi pi-database"></i>
              </div>
              <div class="stock-info">
                <span class="stock-label">Estoque Atual</span>
                <span class="stock-value">{{ stock.originalQuantity.toFixed(1) }}L</span>
              </div>
              @if (getBeerStatus(stock) === 'alert') {
                <i class="pi pi-exclamation-triangle warning-icon"></i>
              }
            </div>
          }

          <!-- Input de Quantidade -->
          <div class="stock-input-group">
            <label [for]="'stock-' + stock.beerId">
              <i class="pi pi-box"></i>
              Quantidade Disponível
            </label>
            <p-inputnumber
              [id]="'stock-' + stock.beerId"
              [(ngModel)]="stock.quantidadeLitros"
              [min]="0"
              [max]="10000"
              suffix=" litros"
              [showButtons]="true"
              [step]="1"
              mode="decimal"
              [minFractionDigits]="1"
              [maxFractionDigits]="1"
              class="w-full"
              placeholder="0 = sem controle"
              pTooltip="0 litros = sem controle de estoque"
              tooltipPosition="top"
            />

            <!-- Informação sobre o modo -->
            @if (stock.quantidadeLitros === 0) {
              <small class="info-text">
                <i class="pi pi-info-circle"></i>
                Sem controle de estoque. Vendas não serão subtraídas.
              </small>
            } @else {
              <small class="info-text success">
                <i class="pi pi-check-circle"></i>
                Controle ativo. Vendas serão subtraídas automaticamente.
              </small>
            }
          </div>

          <!-- Ações -->
          <div class="stock-actions">
            @if (isStockModified(stock)) {
              <p-button
                label="Salvar"
                icon="pi pi-check"
                (onClick)="saveStockForBeer(stock)"
                severity="success"
                [outlined]="true"
                size="small"
              />
            }

            @if (stock.originalQuantity > 0) {
              <p-button
                label="Remover Controle"
                icon="pi pi-times"
                (onClick)="resetStockForBeer(stock)"
                severity="danger"
                [outlined]="true"
                size="small"
                pTooltip="Remove o controle de estoque (volta ao modo normal)"
                tooltipPosition="top"
              />
            }
          </div>
        </div>
      }
    </div>

    @if (beerStocks().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <p>Nenhuma cerveja cadastrada</p>
        <small>Cadastre cervejas em Configurações > Cervejas</small>
      </div>
    }
  </p-card>

  <!-- Card de Configuração de Preços -->
  <p-card class="prices-card">
    <ng-template #header>
      <div class="card-header-with-icon">
        <i class="pi pi-dollar"></i>
        <span>Configuração de Preços</span>
      </div>
    </ng-template>

    <div class="prices-description">
      <i class="pi pi-info-circle"></i>
      <p>
        Defina os preços para cada tamanho de copo (300ml, 500ml e 1000ml) de cada cerveja.
      </p>
    </div>

    <div class="beer-prices-grid">
      @for (price of beerPrices(); track price.beerId) {
        <div class="beer-price-card">
          <!-- Header do card -->
          <div class="beer-price-header">
            <div class="beer-info">
              <div class="beer-color-indicator" [style.background-color]="price.color"></div>
              <h4>{{ price.beerName }}</h4>
            </div>
          </div>

          <!-- Grid de inputs de preços -->
          <div class="price-inputs-grid">
            <!-- Preço 300ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                300ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price300ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>

            <!-- Preço 500ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                500ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price500ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>

            <!-- Preço 1000ml -->
            <div class="price-input-group">
              <label>
                <i class="pi pi-shopping-cart"></i>
                1000ml
              </label>
              <p-inputnumber
                [(ngModel)]="price.price1000ml"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                [min]="0"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                placeholder="R$ 0,00"
              />
            </div>
          </div>

          <!-- Botão de salvar -->
          <div class="beer-price-actions">
            <p-button
              label="Salvar Preços"
              icon="pi pi-check"
              (onClick)="savePriceForBeer(price)"
              severity="success"
              size="small"
              [disabled]="!hasPriceChanges(price)"
            />
          </div>
        </div>
      }
    </div>

    @if (beerPrices().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <p>Nenhuma cerveja cadastrada</p>
        <small>Cadastre cervejas em Configurações > Cervejas</small>
      </div>
    }

    <!-- Botão de salvar todos -->
    @if (beerPrices().length > 0) {
      <div class="save-all-prices-section">
        <p-button
          label="Salvar Todos os Preços"
          icon="pi pi-save"
          (onClick)="saveAllPrices()"
          severity="primary"
          [loading]="isSaving()"
        />
      </div>
    }
  </p-card>

  <!-- Card de Ajuda -->
  <p-card class="help-card">
    <ng-template #header>
      <div class="card-header-with-icon">
        <i class="pi pi-question-circle"></i>
        <span>Como Funciona</span>
      </div>
    </ng-template>

    <div class="help-content">
      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Modo Normal (0 litros)</strong>
          <p>Sem controle de estoque. O sistema não subtrai vendas.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Controle Ativo (> 0 litros)</strong>
          <p>Sistema subtrai automaticamente as vendas do estoque configurado.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Alertas</strong>
          <p>Notificação quando estoque ficar abaixo do limite configurado.</p>
        </div>
      </div>

      <div class="help-item">
        <i class="pi pi-arrow-right"></i>
        <div>
          <strong>Exemplo</strong>
          <p>Configure 50L de IPA. Ao vender 5L (10 copos de 500ml), o estoque cai para 45L automaticamente.</p>
        </div>
      </div>
    </div>
  </p-card>
</div>
