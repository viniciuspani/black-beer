<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="flex flex-col gap-6">
  <p-card>
    <!-- Header do Card -->
    <ng-template pTemplate="header">
      <div class="card-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="pi pi-users"></i>
          </div>
          <div class="header-text">
            <h2 class="header-title">Gestão de Usuários</h2>
            <p class="header-subtitle">Gerencie os usuários da sua empresa</p>
          </div>
        </div>
        <p-button
          label="Novo Usuário"
          icon="pi pi-user-plus"
          severity="success"
          [raised]="true"
          (onClick)="openRegisterDialog()"
          pTooltip="Criar novo usuário"
          tooltipPosition="left">
        </p-button>
      </div>
    </ng-template>

    <!-- Conteúdo -->
    <ng-template pTemplate="content">
      @if (!dbReady()) {
        <div class="loading-container">
          <i class="pi pi-spin pi-spinner text-4xl text-amber-600"></i>
          <p class="text-gray-600 mt-4">Carregando...</p>
        </div>
      } @else if (usuarios().length === 0) {
        <div class="empty-state">
          <i class="pi pi-users text-6xl text-gray-300"></i>
          <h3 class="text-xl font-semibold text-gray-600 mt-4">Nenhum usuário encontrado</h3>
          <p class="text-gray-500 mt-2">Clique em "Novo Usuário" para adicionar o primeiro usuário.</p>
        </div>
      } @else {
        <!-- Seção de Filtros -->
        <div class="filter-section mb-4">
          <div class="filter-header flex items-center gap-2 mb-3">
            <i class="pi pi-filter text-amber-600"></i>
            <span class="font-medium text-gray-700">Filtros</span>
            @if (temFiltrosAtivos()) {
              <p-button
                label="Limpar"
                icon="pi pi-times"
                severity="secondary"
                [text]="true"
                size="small"
                (onClick)="limparFiltros()">
              </p-button>
            }
          </div>
          <div class="filter-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <!-- Filtro por Nome -->
            <div class="filter-field">
              <label for="filtroNome" class="block text-sm text-gray-600 mb-1">Nome</label>
              <input
                pInputText
                id="filtroNome"
                type="text"
                [ngModel]="filtroNome()"
                (ngModelChange)="filtroNome.set($event)"
                placeholder="Buscar por nome..."
                class="w-full" />
            </div>

            <!-- Filtro por Email -->
            <div class="filter-field">
              <label for="filtroEmail" class="block text-sm text-gray-600 mb-1">Email</label>
              <input
                pInputText
                id="filtroEmail"
                type="text"
                [ngModel]="filtroEmail()"
                (ngModelChange)="filtroEmail.set($event)"
                placeholder="Buscar por email..."
                class="w-full" />
            </div>

            <!-- Filtro por Perfil -->
            <div class="filter-field">
              <label for="filtroPerfil" class="block text-sm text-gray-600 mb-1">Perfil</label>
              <p-select
                id="filtroPerfil"
                [options]="perfilOptions"
                [ngModel]="filtroPerfil()"
                (ngModelChange)="filtroPerfil.set($event)"
                placeholder="Todos os perfis"
                [showClear]="true"
                styleClass="w-full">
              </p-select>
            </div>

            <!-- Filtro por Status -->
            <div class="filter-field">
              <label for="filtroStatus" class="block text-sm text-gray-600 mb-1">Status</label>
              <p-select
                id="filtroStatus"
                [options]="statusOptions"
                [ngModel]="filtroStatus()"
                (ngModelChange)="filtroStatus.set($event)"
                placeholder="Todos os status"
                [showClear]="true"
                styleClass="w-full">
              </p-select>
            </div>
          </div>
          @if (temFiltrosAtivos()) {
            <div class="filter-results mt-3 text-sm text-gray-500">
              <i class="pi pi-info-circle mr-1"></i>
              Exibindo {{ usuariosFiltrados().length }} de {{ usuarios().length }} usuário(s)
            </div>
          }
        </div>

        <!-- Tabela Desktop -->
        <div class="table-container hidden md:block">
          <p-table
            [value]="usuariosFiltrados()"
            [paginator]="usuariosFiltrados().length > 10"
            [rows]="10"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuários"
            [rowsPerPageOptions]="[5, 10, 25]"
            styleClass="p-datatable-striped"
            [loading]="isLoading()">

            <ng-template pTemplate="header">
              <tr>
                <th>Usuário</th>
                <th>Email</th>
                <th>Perfil</th>
                <th>Status</th>
                <th>Criado em</th>
                <th class="text-center">Ações</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-user>
              <tr [class.inactive-row]="user.int_user_active === 0">
                <td>
                  <div class="flex items-center gap-2">
                    <div class="user-avatar">
                      <i class="pi pi-user"></i>
                    </div>
                    <span class="font-medium">{{ user.desc_username }}</span>
                  </div>
                </td>
                <td>
                  <span class="text-gray-400">{{ user.desc_email }}</span>
                </td>
                <td>
                  <p-tag
                    [value]="getRoleLabel(user.desc_role)"
                    [severity]="getRoleSeverity(user.desc_role)"
                    [rounded]="true">
                  </p-tag>
                </td>
                <td>
                  <p-tag
                    [value]="getStatusLabel(user.int_user_active)"
                    [severity]="getStatusSeverity(user.int_user_active)"
                    [rounded]="true">
                  </p-tag>
                </td>
                <td>
                  <span class="text-gray-500 text-sm">{{ formatDate(user.dt_created_at) }}</span>
                </td>
                <td class="text-center">
                  @if (user.int_user_active === 1) {
                    <p-button
                      icon="pi pi-ban"
                      severity="danger"
                      [outlined]="true"
                      size="small"
                      pTooltip="Desativar usuário"
                      tooltipPosition="left"
                      (onClick)="confirmToggleUser(user)">
                    </p-button>
                  } @else {
                    <p-button
                      icon="pi pi-check-circle"
                      severity="success"
                      [outlined]="true"
                      size="small"
                      pTooltip="Ativar usuário"
                      tooltipPosition="left"
                      (onClick)="confirmToggleUser(user)">
                    </p-button>
                  }
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6" class="text-center py-8">
                  <i class="pi pi-inbox text-4xl text-gray-300"></i>
                  <p class="text-gray-500 mt-2">Nenhum usuário encontrado</p>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!-- Cards Mobile -->
        <div class="mobile-cards flex md:hidden">
          @for (user of usuariosFiltrados(); track user.num_id) {
            <div class="user-card" [class.inactive-card]="user.int_user_active === 0">
              <div class="user-card-header">
                <div class="user-card-avatar">
                  <i class="pi pi-user"></i>
                </div>
                <div class="user-card-info">
                  <h4 class="user-card-name">{{ user.desc_username }}</h4>
                  <p class="user-card-email">{{ user.desc_email }}</p>
                </div>
                <div class="user-card-action">
                  @if (user.int_user_active === 1) {
                    <p-button
                      icon="pi pi-ban"
                      severity="danger"
                      [outlined]="true"
                      [rounded]="true"
                      size="small"
                      pTooltip="Desativar"
                      (onClick)="confirmToggleUser(user)">
                    </p-button>
                  } @else {
                    <p-button
                      icon="pi pi-check-circle"
                      severity="success"
                      [outlined]="true"
                      [rounded]="true"
                      size="small"
                      pTooltip="Ativar"
                      (onClick)="confirmToggleUser(user)">
                    </p-button>
                  }
                </div>
              </div>
              <div class="user-card-footer">
                <p-tag
                  [value]="getRoleLabel(user.desc_role)"
                  [severity]="getRoleSeverity(user.desc_role)"
                  [rounded]="true">
                </p-tag>
                <p-tag
                  [value]="getStatusLabel(user.int_user_active)"
                  [severity]="getStatusSeverity(user.int_user_active)"
                  [rounded]="true">
                </p-tag>
                <span class="user-card-date">{{ formatDate(user.dt_created_at) }}</span>
              </div>
            </div>
          }
        </div>
      }
    </ng-template>

    <!-- Footer -->
    <ng-template pTemplate="footer">
      <div class="card-footer">
        <div class="footer-info">
          <i class="pi pi-info-circle text-amber-600"></i>
          <span class="text-gray-600 text-sm">
            Total de {{ usuarios().length }} usuário(s) cadastrado(s)
          </span>
        </div>
      </div>
    </ng-template>
  </p-card>
</div>

<!-- Dialog para Criar Novo Usuário -->
<p-dialog
  header="Novo Usuário"
  [(visible)]="showRegisterDialog"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '90vw', maxWidth: '500px' }"
  [contentStyle]="{ overflow: 'auto' }"
  (onHide)="closeRegisterDialog()">

  <app-register
    [embedded]="true"
    (userCreated)="onUserCreated()">
  </app-register>
</p-dialog>
